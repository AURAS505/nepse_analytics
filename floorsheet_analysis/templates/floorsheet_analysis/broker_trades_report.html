{% extends 'base.html' %}
{% load humanize %}

{% block title %}Broker Trades - Hathway Analytics Suite{% endblock %}

{% block styles %}
    {# --- ADDED FLATPICKR CSS --- #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .table-container { 
            max-height: 600px; 
            overflow-y: auto; 
        }
        .table th { 
            position: sticky; 
            top: 0; 
            background-color: #f8f9fa; 
        }
        .sortable-th {
            cursor: pointer;
            position: relative;
        }
        .sortable-th::after, .sortable-th::before {
            content: '';
            position: absolute;
            right: 0.5rem;
            font-size: 0.8em;
            opacity: 0.3;
            border: 4px solid transparent;
        }
        .sortable-th::before {
            content: '';
            border-bottom-color: currentColor;
            top: 0.5rem;
        }
        .sortable-th::after {
            content: '';
            border-top-color: currentColor;
            bottom: 0.5rem;
        }
        .sortable-th.asc::before, .sortable-th.desc::after {
            opacity: 1;
            color: #0d6efd;
        }
        .net-positive { color: #198754; }
        .net-negative { color: #dc3545; }
        .nav-custom .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4B5563;
        }
        .nav-custom .nav-link:hover {
            background-color: #F3F4F6;
        }
        .nav-custom .nav-link.active {
            color: #0d6efd;
            background-color: #e7f1ff;
        }
        /* Style for the script tooltip */
        .script-tooltip {
            cursor: help;
        }
    </style>
{% endblock styles %}

{% block content %}
<div class="container-fluid mt-4">
    <header class="text-center mb-4">
        <h1 class="display-5 fw-bold">Broker-wise Historical Analysis</h1>
    </header>

    <nav class="nav nav-pills flex-column flex-sm-row nav-custom justify-content-center mb-4 bg-white p-2 rounded-3 shadow-sm">
        <a class="flex-sm-fill text-sm-center nav-link" href="{% url 'floorsheet_analysis:settlement_report' %}">Settlement Report</a>
        <a class="flex-sm-fill text-sm-center nav-link" href="#">Live Floorsheet</a>
        <a class="flex-sm-fill text-sm-center nav-link" href="{% url 'floorsheet_analysis:company_trades_report' %}">Company Trades</a>
        <a class="flex-sm-fill text-sm-center nav-link active" aria-current="page" href="{% url 'floorsheet_analysis:broker_trades_report' %}">Broker Trades</a>
        <a class="flex-sm-fill text-sm-center nav-link" href="{% url 'floorsheet_analysis:stock_holding_history_report' %}">Daily Holdings</a>
        <a class="flex-sm-fill text-sm-center nav-link" href="#">Accum/Dist</a>
    </nav>
    
    <div class="card card-body mb-4">
        <form method="POST" action="{% url 'floorsheet_analysis:broker_trades_report' %}">
            {% csrf_token %}
            <div class="row g-3 align-items-end">
                <div class="col-lg-3">
                    <label for="broker_no" class="form-label">Select Broker</label>
                    <select name="broker_no" id="broker_no" class="form-select">
                        {% for broker in brokers %}
                            <option value="{{ broker.broker_no }}" {% if broker.broker_no == selected_broker %}selected{% endif %}>
                                {{ broker.broker_no }} - {{ broker.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-2">
                    <label for="date_range_type" class="form-label">Date Range</label>
                    <select name="date_range_type" id="date_range_type" class="form-select">
                        <option value="custom" {% if selected_date_range_type == 'custom' %}selected{% endif %}>Custom</option>
                        <option value="current_day" {% if selected_date_range_type == 'current_day' %}selected{% endif %}>Current Day</option>
                        <option value="1_week" {% if selected_date_range_type == '1_week' %}selected{% endif %}>1 Week</option>
                        <option value="fortnight" {% if selected_date_range_type == 'fortnight' %}selected{% endif %}>Fortnight</option>
                        <option value="monthly" {% if selected_date_range_type == 'monthly' %}selected{% endif %}>Monthly</option>
                        <option value="quarterly" {% if selected_date_range_type == 'quarterly' %}selected{% endif %}>Quarterly</option>
                        <option value="semi_annually" {% if selected_date_range_type == 'semi_annually' %}selected{% endif %}>Semi-Annually</option>
                        <option value="yearly" {% if selected_date_range_type == 'yearly' %}selected{% endif %}>Yearly</option>
                    </select>
                </div>
                <div class="col-lg-2">
                    <label for="start_date" class="form-label">Start Date</label>
                    {# --- Use type="text" and add disabled attribute --- #}
                    <input type="text" name="start_date" id="start_date" class="form-control" value="{{ start_date }}" {% if selected_date_range_type != 'custom' %}disabled{% endif %}>
                </div>
                <div class="col-lg-2">
                    <label for="end_date" class="form-label">End Date</label>
                    {# --- Use type="text" and add disabled attribute --- #}
                    <input type="text" name="end_date" id="end_date" class="form-control" value="{{ end_date }}" {% if selected_date_range_type != 'custom' %}disabled{% endif %}>
                </div>
                <div class="col-lg-3">
                    <button type="submit" class="btn btn-primary w-100">Analyze</button>
                </div>
            </div>
        </form>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5>Buy Details</h5>
                </div>
                <div class="card-body p-0 table-container">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>SN</th>
                                <th class="sortable-th" data-type="string">Symbol</th>
                                <th class="sortable-th text-end" data-type="numeric">Kitta</th>
                                <th class="sortable-th text-end" data-type="numeric">Amount</th>
                                <th class="sortable-th text-end" data-type="numeric">Rate</th>
                                <th class="sortable-th text-end" data-type="numeric">Ratio %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in buy_data %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td class="script-tooltip" data-script="{{ item.stock_symbol }}">{{ item.stock_symbol }}</td>
                                <td class="text-end">{{ item.total_quantity|intcomma }}</td>
                                <td class="text-end">{{ item.total_amount|floatformat:2|intcomma }}</td>
                                <td class="text-end">{{ item.avg_rate|floatformat:2|intcomma }}</td>
                                <td class="text-end">{{ item.ratio|floatformat:2|intcomma }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5>Sell Details</h5>
                </div>
                <div class="card-body p-0 table-container">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                             <tr>
                                <th>SN</th>
                                <th class="sortable-th" data-type="string">Symbol</th>
                                <th class="sortable-th text-end" data-type="numeric">Kitta</th>
                                <th class="sortable-th text-end" data-type="numeric">Amount</th>
                                <th class="sortable-th text-end" data-type="numeric">Rate</th>
                                <th class="sortable-th text-end" data-type="numeric">Ratio %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in sell_data %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td class="script-tooltip" data-script="{{ item.stock_symbol }}">{{ item.stock_symbol }}</td>
                                <td class="text-end">{{ item.total_quantity|intcomma }}</td>
                                <td class="text-end">{{ item.total_amount|floatformat:2|intcomma }}</td>
                                <td class="text-end">{{ item.avg_rate|floatformat:2|intcomma }}</td>
                                <td class="text-end">{{ item.ratio|floatformat:2|intcomma }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5>Net Details (Buy - Sell)</h5>
                </div>
                <div class="card-body p-0 table-container">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                             <tr>
                                <th>SN</th>
                                <th class="sortable-th" data-type="string">Symbol</th>
                                <th class="sortable-th text-end" data-type="numeric">Net Kitta</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in net_data %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td class="script-tooltip" data-script="{{ item.stock_symbol }}">{{ item.stock_symbol }}</td>
                                <td class="text-end {% if item.net_quantity > 0 %}net-positive{% elif item.net_quantity < 0 %}net-negative{% endif %}">
                                    {{ item.net_quantity|intcomma }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Load Company Name Map ---
    const companyNameMap = {{ company_name_map_json|safe }};

    // --- Apply Tooltips to Symbols ---
    document.querySelectorAll('.script-tooltip').forEach(td => {
        const script = td.dataset.script;
        const companyName = companyNameMap[script];
        if (companyName) {
            td.setAttribute('title', companyName);
            td.style.cursor = 'help'; // Add help cursor
        }
    });

    // --- CALENDAR LOGIC (CORRECTED) ---
    const dateRangeTypeSelect = document.getElementById('date_range_type');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    const availableDatesDb = {{ available_dates_db_json|safe }};
    const sortedAvailableDates = [...availableDatesDb].sort((a, b) => new Date(b) - new Date(a)); // Sort descending

    // Initialize flatpickr (the calendar pop-up)
    flatpickr("#start_date", { 
        dateFormat: "Y-m-d", 
        enable: availableDatesDb.length ? availableDatesDb : undefined,
    });
    flatpickr("#end_date", { 
        dateFormat: "Y-m-d", 
        enable: availableDatesDb.length ? availableDatesDb : undefined,
    });

    function getNthTradingDay(targetDateStr, numDays, availableDates) {
        let targetDate = new Date(targetDateStr);
        targetDate.setHours(0, 0, 0, 0);
        let foundDatesCount = 0;
        let resultDate = targetDate;
        
        for (let i = 0; i < availableDates.length; i++) {
            let currentDate = new Date(availableDates[i]);
            currentDate.setHours(0, 0, 0, 0);
            
            if (currentDate <= targetDate) {
                foundDatesCount++;
                resultDate = currentDate;
                if (foundDatesCount >= numDays) break;
            }
        }
        return resultDate.toISOString().split('T')[0];
    }

    function updateDateInputsDisplay() {
        const selectedType = dateRangeTypeSelect.value;
        const endDateValue = endDateInput.value;
        
        // --- THIS IS THE FIX ---
        // Use .disabled to "freeze" the inputs, matching the settlement report logic
        const isCustom = (selectedType === 'custom');
        startDateInput.disabled = !isCustom;
        endDateInput.disabled = !isCustom;
        // --- END FIX ---
        
        if (selectedType === 'current_day') {
            const latestDate = sortedAvailableDates.length > 0 ? sortedAvailableDates[0] : new Date().toISOString().split('T')[0];
            startDateInput.value = latestDate;
            endDateInput.value = latestDate;
            return;
        }
        if (selectedType === 'custom') {
            return;
        }
        
        if (!endDateValue) return; 
        
        let numDays;
        switch (selectedType) {
            case '1_week': numDays = 7; break;
            case 'fortnight': numDays = 15; break;
            case 'monthly': numDays = 30; break;
            case 'quarterly': numDays = 90; break;
            case 'semi_annually': numDays = 180; break;
            case 'yearly': numDays = 360; break;
            default: return;
        }
        startDateInput.value = getNthTradingDay(endDateValue, numDays, sortedAvailableDates);
    }
    
    dateRangeTypeSelect.addEventListener('change', updateDateInputsDisplay);
    endDateInput.addEventListener('change', updateDateInputsDisplay);
    
    // Run on page load to set the correct initial state
    updateDateInputsDisplay();

    // --- Table Sorting (This logic is correct) ---
    function sortTable(tableBody, columnIndex, sortAsc, isNumeric) {
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        const direction = sortAsc ? 1 : -1;

        rows.sort((rowA, rowB) => {
            const cellA = rowA.querySelectorAll('td')[columnIndex].innerText;
            const cellB = rowB.querySelectorAll('td')[columnIndex].innerText;

            if (isNumeric) {
                let valA = parseFloat(cellA.replace(/[,%]/g, '')) || 0;
                let valB = parseFloat(cellB.replace(/[,%]/g, '')) || 0;
                return (valA - valB) * direction;
            } else {
                return cellA.localeCompare(cellB) * direction;
            }
        });

        rows.forEach(row => tableBody.appendChild(row));
    }

    document.querySelectorAll('.sortable-th').forEach(header => {
        header.addEventListener('click', () => {
            const table = header.closest('table');
            const tableBody = table.querySelector('tbody');
            const headerIndex = header.cellIndex; 
            const currentIsAsc = header.classList.contains('asc');
            const isNumeric = header.dataset.type === 'numeric';

            table.querySelectorAll('.sortable-th').forEach(th => {
                th.classList.remove('asc', 'desc');
            });

            header.classList.toggle('asc', !currentIsAsc);
            header.classList.toggle('desc', currentIsAsc);
            
            sortTable(tableBody, headerIndex, !currentIsAsc, isNumeric);
        });
    });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock scripts %}
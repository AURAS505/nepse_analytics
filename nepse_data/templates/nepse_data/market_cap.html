{% extends 'base.html' %}

{% block title %}{{ title }} - NEPSE Analytics{% endblock %}

{% block styles %}
    <style>
        /* All your old styles are unchanged */
        .table-responsive {
            max-height: 80vh;
        }
        .table {
            font-size: 0.85rem;
        }
        .table th { 
            position: sticky; 
            top: 0; 
            background-color: #e9ecef;
            z-index: 10; 
            font-weight: 600;
            color: #333;
        }
        .table th.sortable {
            cursor: pointer;
            user-select: none;
            white-space: normal;
        }
        /* ... (other styles) ... */
    </style>
{% endblock %}

{% block content %}

<div class="row">
    <div class="col-xl-12 mx-auto">
        <div class="card shadow-sm border-0 mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ title }}</h5>
                <a href="{% url 'nepse_data:download_marcap' %}" class="btn btn-success btn-sm">Download as CSV</a>
            </div>
            <div class="card-body">

                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                    <form method="GET" action="{% url 'nepse_data:market_cap' %}" class="d-inline-flex align-items-center me-3 mb-2">
                        <label for="per_page" class="form-label me-2 mb-0" style="white-space: nowrap;">Rows:</label>
                        <select name="per_page" id="per_page" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
                            <option value="20" {% if per_page == '20' %}selected{% endif %}>20</option>
                            <option value="50" {% if per_page == '50' %}selected{% endif %}>50</option>
                            <option value="100" {% if per_page == '100' %}selected{% endif %}>100</option>
                            <option value="500" {% if per_page == '500' %}selected{% endif %}>500</option>
                            <option value="All" {% if per_page == 'All' %}selected{% endif %}>All</option>
                        </select>
                    </form>

                    {% if page_obj %}
                    <nav aria-label="Page navigation" class="mb-2">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                                <a class="page-link" href="?per_page={{ per_page }}&page=1">&laquo;</a>
                            </li>
                            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                                <a class="page-link" href="{% if page_obj.has_previous %}?per_page={{ per_page }}&page={{ page_obj.previous_page_number }}{% else %}#{% endif %}">Prev</a>
                            </li>

                            <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span></li>

                            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                                <a class="page-link" href="{% if page_obj.has_next %}?per_page={{ per_page }}&page={{ page_obj.next_page_number }}{% else %}#{% endif %}">Next</a>
                            </li>
                            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                                <a class="page-link" href="?per_page={{ per_page }}&page={{ paginator.num_pages }}">&raquo;</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>
                <div class="table-responsive">
                    <table id="marcapTable" class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="sortable">Business Date</th>
                                <th class="sortable text-end">Market Cap</th>
                                <th class="sortable text-end">Sensitive Market Cap</th>
                                <th class="sortable text-end">Float Market Cap</th>
                                <th class="sortable text-end">Sensitive Float Market Cap</th>
                                <th class="sortable text-end">Total Turnover</th>
                                <th class="sortable text-end">Total Traded Shares</th>
                                <th class="sortable text-end">Total Transactions</th>
                                <th class="sortable text-end">Total Scrips Traded</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in marcap_data %}
                            <tr>
                                <td>{{ item.business_date|date:"Y-m-d" }}</td>
                                <td>{{ item.market_capitalization|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.sensitive_market_capitalization|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.float_market_capitalization|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.sensitive_float_market_capitalization|floatformat:2|default_if_none:'N/A' }}</td>

                                <td class="text-end">{{ item.total_turnover|floatformat:2|default_if_none:'N/A' }}</td>
                                <td class="text-end">{{ item.total_traded_shares|floatformat:0|default_if_none:'N/A' }}</td>
                                <td class="text-end">{{ item.total_transactions|floatformat:0|default_if_none:'N/A' }}</td>
                                <td class="text-end">{{ item.total_scrips_traded|floatformat:0|default_if_none:'N/A' }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">No market capitalization data found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function() {
        'use strict';

        // --- UPDATED CONFIG ---
        const VIEW_CONFIGS = {
            9: { // New 9-column config
                stringColumns: [0], // Date
                floatColumns: [1, 2, 3, 4, 5], // Market Cap and Turnover
                defaultSort: null // Sorting is server-side
            },
            // ... (your other configs) ...
        };
        // ... (rest of your existing JS for formatNumbersInTable, sortTable, etc.) ...

        function getViewConfig(headerCount) {
            // Find config by header count
            const ths = document.querySelectorAll('#marcapTable thead th');
            return VIEW_CONFIGS[ths.length] || null;
        }

        function formatNumbersInTable() {
            const table = document.getElementById('marcapTable');
            if (!table) return;

            const config = getViewConfig();
            if (!config) return;

            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                if (row.cells.length <= 1) return;

                for (let i = 0; i < row.cells.length; i++) {
                    if (config.stringColumns.includes(i)) continue;

                    const cell = row.cells[i];
                    const text = cell.textContent.trim();

                    if (!text || text === 'N/A') continue;

                    const num = parseFloat(text.replace(/,/g, ''));

                    if (!isNaN(num)) {
                        if (config.floatColumns.includes(i)) {
                            cell.textContent = num.toLocaleString('en-US', { 
                                minimumFractionDigits: 2, 
                                maximumFractionDigits: 2 
                            });
                        } else {
                            // For integers like Total Trades
                            cell.textContent = num.toLocaleString('en-US');
                        }
                        cell.style.textAlign = 'right';
                        cell.style.fontVariantNumeric = 'tabular-nums';
                    }
                }
            });
        }

        function sortTable(columnIndex) {
            const table = document.getElementById('marcapTable');
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const headers = table.querySelectorAll('thead th');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            if (rows.length === 0 || rows[0].cells.length <= 1) return;

            const config = getViewConfig();
            if (!config) return;

            const currentDirection = headers[columnIndex].classList.contains('asc') ? 'desc' : 'asc';

            headers.forEach(th => th.classList.remove('asc', 'desc'));
            headers[columnIndex].classList.add(currentDirection);

            rows.sort((a, b) => {
                let aText = a.cells[columnIndex].textContent.trim().replace(/,/g, '');
                let bText = b.cells[columnIndex].textContent.trim().replace(/,/g, '');

                let comparison;

                if (config.stringColumns.includes(columnIndex)) {
                    comparison = aText.localeCompare(bText, undefined, { sensitivity: 'base' });
                } else {
                    if (aText === 'N/A') aText = '';
                    if (bText === 'N/A') bText = '';

                    const aNum = parseFloat(aText);
                    const bNum = parseFloat(bText);

                    if (isNaN(aNum) && isNaN(bNum)) comparison = 0;
                    else if (isNaN(aNum)) comparison = -1;
                    else if (isNaN(bNum)) comparison = 1;
                    else comparison = aNum - bNum;
                }

                return currentDirection === 'asc' ? comparison : -comparison;
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        document.addEventListener('DOMContentLoaded', function() {
            formatNumbersInTable(); 

            const pricesTable = document.getElementById('marcapTable');
            if (!pricesTable) return;

            pricesTable.querySelectorAll('th.sortable').forEach((header, index) => {
                header.addEventListener('click', () => sortTable(index));
            });
        });

    })();
</script>
{% endblock %}
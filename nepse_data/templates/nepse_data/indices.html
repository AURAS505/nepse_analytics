{% extends 'base.html' %}

{% block title %}{{ title }} - NEPSE Analytics{% endblock %}

{% block styles %}
    <style>
        /* All your old styles are unchanged and go here */
        .table-responsive {
            max-height: 80vh;
        }
        .table {
            font-size: 0.85rem;
        }
        .table th { 
            position: sticky; 
            top: 0; 
            background-color: #e9ecef;
            z-index: 10; 
            font-weight: 600;
            color: #333;
        }
        .table th.sortable {
            cursor: pointer;
            user-select: none;
            white-space: normal;
        }
        .table th.sortable:hover {
            background-color: #dee2e6;
        }
        .table th.sortable::after {
            content: '\2195';
            font-size: 0.9em;
            margin-left: 5px;
            opacity: 0.3;
        }
        .table th.sortable.asc::after {
            content: '\2191';
            opacity: 1;
        }
        .table th.sortable.desc::after {
            content: '\2193';
            opacity: 1;
        }
        .nav-custom .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4B5563;
            transition: background-color 0.2s;
        }
        .nav-custom .nav-link:hover {
            background-color: #F3F4F6;
        }
        .nav-custom .nav-link.active {
            color: #0d6efd;
            background-color: #e7f1ff;
        }
        .card-header {
            background-color: #f6f9fc !important;
            border-bottom: 1px solid #e1e8f0;
        }
        .table-hover > tbody > tr:hover {
            background-color: #eef5ff !important;
        }
    </style>
{% endblock %}

{% block content %}

<nav class="nav nav-pills flex-column flex-sm-row nav-custom justify-content-center mb-4 bg-white p-2 rounded-3 shadow-sm">
    <a class="flex-sm-fill text-sm-center nav-link {% if view == 'date' %}active{% endif %}" 
       href="{% url 'nepse_data:indices' %}?view=date">By Date</a>

    <a class="flex-sm-fill text-sm-center nav-link {% if view == 'indices' %}active{% endif %}" 
       href="{% url 'nepse_data:indices' %}?view=indices">By Index</a>
</nav>

<div class="row">
    <div class="col-xl-12 mx-auto">

        {% if view == 'date' %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-center">
                <h5 class="mb-2 mb-md-0">{{ title }} {% if selected_date_str %}for {{ selected_date_str }}{% endif %}</h5>
                <div class="d-flex align-items-center">
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" id="priceSearch" onkeyup="filterTable()" class="form-control form-control-sm" placeholder="Search by Index Name...">
                    </div>
                    <form method="GET" action="{% url 'nepse_data:indices' %}" class="d-flex ms-2">
                        <input type="hidden" name="view" value="date">
                        <input type="date" name="selected_date" class="form-control form-control-sm" value="{{ selected_date_str|default_if_none:'' }}">
                        <button type="submit" class="btn btn-primary btn-sm ms-1">Go</button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <a href="{% url 'nepse_data:download_indices' %}?view=date&selected_date={{ selected_date_str|default_if_none:'' }}" class="btn btn-success btn-sm">Download as CSV</a>
                </div>

                <div class="table-responsive">
                    <table id="pricesTable" class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="sortable">SN</th>
                                <th class="sortable">Date</th>
                                <th class="sortable">Index Name</th>
                                <th class="sortable text-end">Open</th>
                                <th class="sortable text-end">High</th>
                                <th class="sortable text-end">Low</th>
                                <th class="sortable text-end">Close</th>
                                <th class="sortable text-end">Abs Change</th>
                                <th class="sortable text-end">% Change</th>
                                <th class="sortable text-end">52W High</th>
                                <th class="sortable text-end">52W Low</th>
                                <th class="sortable text-end">Turnover (Value)</th>
                                <th class="sortable text-end">Turnover (Volume)</th>
                                <th class="sortable text-end">Total Trades</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in indices_data %}
                            <tr>
                                <td>{{ item.sn }}</td>
                                <td>{{ item.date|date:"Y-m-d" }}</td>
                                <td>{{ item.sector }}</td>
                                <td>{{ item.open|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.high|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.low|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.close|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.absolute_change|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.percentage_change|default_if_none:'N/A' }}</td>
                                <td>{{ item.number_52_weeks_high|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.number_52_weeks_low|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.turnover_values|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.turnover_volume|floatformat:0|default_if_none:'N/A' }}</td>
                                <td>{{ item.total_transaction|floatformat:0|default_if_none:'N/A' }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="14" class="text-center">No index data found for {% if selected_date_str %}{{ selected_date_str }}{% else %}the latest trading day{% endif %}.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% elif view == 'indices' %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0">Search History by Index</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{% url 'nepse_data:indices' %}" class="row g-3 align-items-end">
                    <input type="hidden" name="view" value="indices">
                    <input type="hidden" name="per_page" value="{{ per_page }}">
                    <div class="col-md-4">
                        <label for="search_term" class="form-label">Index Name</label>
                        <input type="text" name="search_term" id="search_term" class="form-control" value="{{ search_term|default_if_none:'' }}" placeholder="e.g., NEPSE Index" list="index-list" autocomplete="off">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Search</button>
                    </div>
                </form>

                <datalist id="index-list">
                    {% for index in all_indices_list %}
                        <option value="{{ index.sector }}">{{ index.sector }}</option>
                    {% endfor %}
                </datalist>
            </div>
        </div>

        <div class="card shadow-sm border-0 mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    {% if search_term %}
                        Search Results for "{{ search_term }}"
                    {% else %}
                        {{ title }}
                    {% endif %}
                </h5>
                <a href="{% url 'nepse_data:download_indices' %}?view=indices&search_term={{ search_term|default_if_none:'' }}" class="btn btn-success btn-sm">Download as CSV</a>
            </div>
            <div class="card-body">

                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                    <form method="GET" action="{% url 'nepse_data:indices' %}" class="d-inline-flex align-items-center me-3 mb-2">
                        <input type="hidden" name="view" value="indices">
                        <input type="hidden" name="search_term" value="{{ search_term|default_if_none:'' }}">
                        <label for="per_page" class="form-label me-2 mb-0" style="white-space: nowrap;">Rows:</label>
                        <select name="per_page" id="per_page" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
                            <option value="20" {% if per_page == '20' %}selected{% endif %}>20</option>
                            <option value="50" {% if per_page == '50' %}selected{% endif %}>50</option>
                            <option value="100" {% if per_page == '100' %}selected{% endif %}>100</option>
                            <option value="500" {% if per_page == '500' %}selected{% endif %}>500</option>
                            <option value="All" {% if per_page == 'All' %}selected{% endif %}>All</option>
                        </select>
                    </form>

                    {% if page_obj %}
                    <nav aria-label="Page navigation" class="mb-2">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                                <a class="page-link" href="?view={{ view }}&search_term={{ search_term }}&per_page={{ per_page }}&page=1">&laquo;</a>
                            </li>
                            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                                <a class="page-link" href="{% if page_obj.has_previous %}?view={{ view }}&search_term={{ search_term }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}{% else %}#{% endif %}">Prev</a>
                            </li>

                            <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span></li>

                            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                                <a class="page-link" href="{% if page_obj.has_next %}?view={{ view }}&search_term={{ search_term }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}{% else %}#{% endif %}">Next</a>
                            </li>
                            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                                <a class="page-link" href="?view={{ view }}&search_term={{ search_term }}&per_page={{ per_page }}&page={{ paginator.num_pages }}">&raquo;</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>
                <div class="table-responsive">
                    <table id="pricesTable" class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="sortable">SN</th>
                                <th class="sortable">Date</th>
                                <th class="sortable">Index Name</th>
                                <th class="sortable text-end">Open</th>
                                <th class="sortable text-end">High</th>
                                <th class="sortable text-end">Low</th>
                                <th class="sortable text-end">Close</th>
                                <th class="sortable text-end">Abs Change</th>
                                <th class="sortable text-end">% Change</th>
                                <th class="sortable text-end">52W High</th>
                                <th class="sortable text-end">52W Low</th>
                                <th class="sortable text-end">Turnover (Value)</th>
                                <th class="sortable text-end">Turnover (Volume)</th>
                                <th class="sortable text-end">Total Trades</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in indices_data %}
                            <tr>
                                <td>{{ item.sn }}</td>
                                <td>{{ item.date|date:"Y-m-d" }}</td>
                                <td>{{ item.sector }}</td>
                                <td>{{ item.open|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.high|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.low|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.close|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.absolute_change|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.percentage_change|default_if_none:'N/A' }}</td>
                                <td>{{ item.number_52_weeks_high|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.number_52_weeks_low|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.turnover_values|floatformat:2|default_if_none:'N/A' }}</td>
                                <td>{{ item.turnover_volume|floatformat:0|default_if_none:'N/A' }}</td>
                                <td>{{ item.total_transaction|floatformat:0|default_if_none:'N/A' }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="14" class="text-center">
                                    {% if search_term %}
                                        No index data found matching your search.
                                    {% else %}
                                        No index data found in the database.
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% endif %}

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function() {
        'use strict';

        const VIEW_CONFIGS = {
            14: { 
                stringColumns: [1, 2, 8],
                floatColumns: [3, 4, 5, 6, 7, 9, 10, 11],
                filterColumns: { symbol: 2 },
                defaultSort: { column: 2, order: 'asc' },
                factorColumn: -1
            },
            // ... (your other configs) ...
        };

        function getViewConfig(headerCount) {
            return VIEW_CONFIGS[headerCount] || null;
        }

        function formatNumbersInTable() {
            const table = document.getElementById('pricesTable');
            if (!table) return;

            const headers = table.querySelectorAll('thead th');
            const config = getViewConfig(headers.length);
            if (!config) return;

            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                if (row.cells.length <= 1) return;

                for (let i = 0; i < row.cells.length; i++) {
                    if (config.stringColumns.includes(i)) continue;

                    const cell = row.cells[i];
                    const text = cell.textContent.trim();

                    if (!text || text === 'N/A') continue;

                    const num = parseFloat(text.replace(/,/g, ''));

                    if (!isNaN(num)) {
                        if (config.floatColumns.includes(i)) {
                            cell.textContent = num.toLocaleString('en-US', { 
                                minimumFractionDigits: 2, 
                                maximumFractionDigits: 2 
                            });
                        } else {
                            cell.textContent = num.toLocaleString('en-US');
                        }
                        cell.style.textAlign = 'right';
                        cell.style.fontVariantNumeric = 'tabular-nums';
                    }
                }
            });
        }

        function sortTable(columnIndex) {
            const table = document.getElementById('pricesTable');
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const headers = table.querySelectorAll('thead th');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            if (rows.length === 0 || rows[0].cells.length <= 1) return;

            const config = getViewConfig(headers.length);
            if (!config) return;

            const currentDirection = headers[columnIndex].classList.contains('asc') ? 'desc' : 'asc';

            headers.forEach(th => th.classList.remove('asc', 'desc'));
            headers[columnIndex].classList.add(currentDirection);

            rows.sort((a, b) => {
                let aText = a.cells[columnIndex].textContent.trim().replace(/,/g, '');
                let bText = b.cells[columnIndex].textContent.trim().replace(/,/g, '');

                let comparison;

                if (config.stringColumns.includes(columnIndex)) {
                    comparison = aText.localeCompare(bText, undefined, { sensitivity: 'base' });
                } else {
                    if (aText === 'N/A') aText = '';
                    if (bText === 'N/A') bText = '';

                    const aNum = parseFloat(aText);
                    const bNum = parseFloat(bText);

                    if (isNaN(aNum) && isNaN(bNum)) comparison = 0;
                    else if (isNaN(aNum)) comparison = -1;
                    else if (isNaN(bNum)) comparison = 1;
                    else comparison = aNum - bNum;
                }

                return currentDirection === 'asc' ? comparison : -comparison;
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        function filterTable() {
            const filterInput = document.getElementById('priceSearch');
            if (!filterInput) return;

            const filter = filterInput.value.toUpperCase();
            const table = document.getElementById('pricesTable');
            const headers = table.querySelectorAll('thead th');
            const config = getViewConfig(headers.length);

            if (!config || !config.filterColumns) return;

            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                if (row.cells.length <= 1) return;
                let matches = false;

                if (config.filterColumns.symbol !== undefined) {
                    const symbolText = row.cells[config.filterColumns.symbol].textContent.toUpperCase();
                    matches = symbolText.includes(filter);
                }

                row.style.display = matches ? '' : 'none';
            });
        }

        function applyDefaultSort() {
            const table = document.getElementById('pricesTable');
            if (!table) return;

            const headers = table.querySelectorAll('thead th');
            const rows = table.querySelector('tbody tr');

            if (!rows || rows.cells.length <=1) return; 

            const config = getViewConfig(headers.length);
            if (!config || !config.defaultSort) return;

            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view') || 'date';

            let sortColumn = config.defaultSort.column;
            let sortOrder = config.defaultSort.order;

            if (window.location.pathname.includes('/indices')) {
                if (view === 'date') {
                    sortColumn = 2; // Sort by Index Name (col 2) Asc
                    sortOrder = 'asc';
                } else {
                    // 'By Index' is server-sorted, no client sort needed
                    return; 
                }
            }

            if (sortOrder === 'desc') {
                sortTable(sortColumn); 
                sortTable(sortColumn); 
            } else {
                sortTable(sortColumn);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            formatNumbersInTable(); 

            const pricesTable = document.getElementById('pricesTable');
            if (!pricesTable) return;

            pricesTable.querySelectorAll('th.sortable').forEach((header, index) => {
                header.addEventListener('click', () => sortTable(index));
            });

            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view') || 'date';
            if (view === 'date') {
                setTimeout(applyDefaultSort, 50);
            }
        });

        window.filterTable = filterTable;
    })();
</script>
{% endblock %}
{% extends 'base.html' %}

{% block title %}{{ title }} - NEPSE Analytics{% endblock %}

{% block styles %}
    <style>
        /* ... (all your styles from the original file are unchanged) ... */
        .table-responsive {
            max-height: 80vh;
        }
        .table {
            font-size: 0.85rem;
        }
        .table th { 
            position: sticky; 
            top: 0; 
            background-color: #e9ecef;
            z-index: 10; 
            font-weight: 600;
            color: #333;
        }
        .table th.sortable {
            cursor: pointer;
            user-select: none;
            white-space: normal;
        }
        .table th.sortable:hover {
            background-color: #dee2e6;
        }
        .table th.sortable::after {
            content: '\2195';
            font-size: 0.9em;
            margin-left: 5px;
            opacity: 0.3;
        }
        .table th.sortable.asc::after {
            content: '\2191';
            opacity: 1;
        }
        .table th.sortable.desc::after {
            content: '\2193';
            opacity: 1;
        }
        .nav-custom .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4B5563;
            transition: background-color 0.2s;
        }
        .nav-custom .nav-link:hover {
            background-color: #F3F4F6;
        }
        .nav-custom .nav-link.active {
            color: #0d6efd;
            background-color: #e7f1ff;
        }
        .card-header {
            background-color: #f6f9fc !important;
            border-bottom: 1px solid #e1e8f0;
        }
        .table-hover > tbody > tr:hover {
            background-color: #eef5ff !important;
        }
        .col-adj {
            background-color: #f0f5ff !important;
            font-weight: 500;
        }
        .th-adj {
            background-color: #ddeaff !important;
            color: #0033a0 !important;
        }
    </style>
{% endblock %}

{% block content %}

<nav class="nav nav-pills flex-column flex-sm-row nav-custom justify-content-center mb-4 bg-white p-2 rounded-3 shadow-sm">
    <a class="flex-sm-fill text-sm-center nav-link {% if view == 'date' %}active{% endif %}" 
       href="{% url 'nepse_data:todays_price' %}?view=date">By Date</a>
       
    <a class="flex-sm-fill text-sm-center nav-link {% if view == 'company' %}active{% endif %}" 
       href="{% url 'nepse_data:todays_price' %}?view=company">By Company</a>
       
    <a class="flex-sm-fill text-sm-center nav-link {% if view == 'adjusted' %}active{% endif %}" 
       href="{% url 'nepse_data:todays_price' %}?view=adjusted">Adj Price by Date</a>
       
    <a class="flex-sm-fill text-sm-center nav-link {% if view == 'corporate' %}active{% endif %}" 
       href="{% url 'nepse_data:todays_price' %}?view=corporate">Adj Price by Company</a>
</nav>

<div class="row">
    <div class="col-xl-12 mx-auto">

        {% if view == 'date' %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-center">
                <h5 class="mb-2 mb-md-0">{{ title }} {% if selected_date_str %}for {{ selected_date_str }}{% endif %}</h5>
                <div class="d-flex align-items-center">
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" id="priceSearch" onkeyup="filterTable()" class="form-control form-control-sm" placeholder="Search by Symbol or Name...">
                    </div>
                    <form method="GET" action="{% url 'nepse_data:todays_price' %}" class="d-flex ms-2">
                        <input type="hidden" name="view" value="date">
                        <input type="date" name="selected_date" class="form-control form-control-sm" value="{{ selected_date_str|default_if_none:'' }}">
                        <button type="submit" class="btn btn-primary btn-sm ms-1">Go</button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <a href="{% url 'nepse_data:download_stock_prices' %}?view=date&selected_date={{ selected_date_str|default_if_none:'' }}" class="btn btn-success btn-sm">Download as CSV</a>
                </div>

                <div class="table-responsive">
                    <table id="pricesTable" class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="sortable">Id</th>
                                <th class="sortable">Business Date</th>
                                <th class="sortable">Security Id</th>
                                <th class="sortable">Symbol</th>
                                <th class="sortable">Security Name</th>
                                <th class="sortable text-end">Open Price</th>
                                <th class="sortable text-end">High Price</th>
                                <th class="sortable text-end">Low Price</th>
                                <th class="sortable text-end">Close Price</th>
                                <th class="sortable text-end">Total Traded Quantity</th>
                                <th class="sortable text-end">Total Traded Value</th>
                                <th class="sortable text-end">Previous Close</th>
                                <th class="sortable text-end">Fifty Two Week High</th>
                                <th class="sortable text-end">Fifty Two Week Low</th>
                                <th class="sortable">Last Updated Time</th>
                                <th class="sortable text-end">Last Updated Price</th>
                                <th class="sortable text-end">Total Trades</th>
                                <th class="sortable text-end">Average Traded Price</th>
                                <th class="sortable text-end">Market Capitalization</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in stock_prices %}
                            <tr>
                                <td>{{ price.id }}</td>
                                <td>{{ price.business_date|date:"Y-m-d" }}</td>
                                <td>{{ price.security_id }}</td>
                                <td>{{ price.symbol }}</td>
                                <td>{{ price.security_name }}</td>
                                <td>{{ price.open_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.high_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.low_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.close_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.total_traded_quantity|default_if_none:'N/A' }}</td>
                                <td>{{ price.total_traded_value|default_if_none:'N/A' }}</td>
                                <td>{{ price.previous_close|default_if_none:'N/A' }}</td>
                                <td>{{ price.fifty_two_week_high|default_if_none:'N/A' }}</td>
                                <td>{{ price.fifty_two_week_low|default_if_none:'N/A' }}</td>
                                <td>{{ price.last_updated_time }}</td>
                                <td>{{ price.last_updated_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.total_trades|default_if_none:'N/A' }}</td>
                                <td>{{ price.average_traded_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.market_capitalization|default_if_none:'N/A' }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="19" class="text-center">No stock price data found for {% if selected_date_str %}{{ selected_date_str }}{% else %}the latest trading day{% endif %}.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% elif view == 'company' %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0">Search Prices by Company</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{% url 'nepse_data:todays_price' %}" class="row g-3 align-items-end">
                    <input type="hidden" name="view" value="company">
                    <div class="col-md-4">
                        <label for="search_term" class="form-label">Symbol or Company Name</label>
                        <input type="text" name="search_term" id="search_term" class="form-control" value="{{ search_term|default_if_none:'' }}" placeholder="e.g., NABIL or Nabil Bank" list="company-list" autocomplete="off">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </div>
                </form>

                <datalist id="company-list">
                    {% for company in all_companies %}
                        <option value="{{ company.script_ticker }}">{{ company.company_name }}</option>
                        <option value="{{ company.company_name }}">{{ company.script_ticker }}</option>
                    {% endfor %}
                </datalist>
            </div>
        </div>

        {% if search_term %}
        <div class="card shadow-sm border-0 mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Search Results for "{{ search_term }}"</h5>
                <a href="{% url 'nepse_data:download_stock_prices' %}?view=company&search_term={{ search_term|default_if_none:'' }}" class="btn btn-success btn-sm">Download as CSV</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="pricesTable" class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="sortable">Id</th>
                                <th class="sortable">Business Date</th>
                                <th class="sortable text-end">Open Price</th>
                                <th class="sortable text-end">High Price</th>
                                <th class="sortable text-end">Low Price</th>
                                <th class="sortable text-end">Close Price</th>
                                <th class="sortable text-end">Total Traded Quantity</th>
                                <th class="sortable text-end">Total Traded Value</th>
                                <th class="sortable text-end">Previous Close</th>
                                <th class="sortable text-end">Fifty Two Week High</th>
                                <th class="sortable text-end">Fifty Two Week Low</th>
                                <th class="sortable">Last Updated Time</th>
                                <th class="sortable text-end">Last Updated Price</th>
                                <th class="sortable text-end">Total Trades</th>
                                <th class="sortable text-end">Average Traded Price</th>
                                <th class="sortable text-end">Market Capitalization</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in stock_prices %}
                            <tr>
                                <td>{{ price.id }}</td>
                                <td>{{ price.business_date|date:"Y-m-d" }}</td>
                                <td>{{ price.open_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.high_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.low_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.close_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.total_traded_quantity|default_if_none:'N/A' }}</td>
                                <td>{{ price.total_traded_value|default_if_none:'N/A' }}</td>
                                <td>{{ price.previous_close|default_if_none:'N/A' }}</td>
                                <td>{{ price.fifty_two_week_high|default_if_none:'N/A' }}</td>
                                <td>{{ price.fifty_two_week_low|default_if_none:'N/A' }}</td>
                                <td>{{ price.last_updated_time }}</td>
                                <td>{{ price.last_updated_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.total_trades|default_if_none:'N/A' }}</td>
                                <td>{{ price.average_traded_price|default_if_none:'N/A' }}</td>
                                <td>{{ price.market_capitalization|default_if_none:'N/A' }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="16" class="text-center">No stock price data found matching your search.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% elif view == 'adjusted' %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-center">
                <h5 class="mb-2 mb-md-0">{{ title }} {% if selected_date_str %}for {{ selected_date_str }}{% endif %}</h5>
                <div class="d-flex align-items-center">
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" id="priceSearch" onkeyup="filterTable()" class="form-control form-control-sm" placeholder="Search by Symbol...">
                    </div>
                    <form method="GET" action="{% url 'nepse_data:todays_price' %}" class="d-flex ms-2">
                        <input type="hidden" name="view" value="adjusted">
                        <input type="date" name="selected_date" class="form-control form-control-sm" value="{{ selected_date_str|default_if_none:'' }}">
                        <button type="submit" class="btn btn-primary btn-sm ms-1">Go</button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <a href="{% url 'nepse_data:download_stock_prices' %}?view=adjusted&selected_date={{ selected_date_str|default_if_none:'' }}" class="btn btn-success btn-sm">Download as CSV</a>
                </div>

                <div class="table-responsive">
                    <table id="pricesTable" class="table table-striped table-hover table-bordered mb-0">
                        <thead>
                            <tr>
                                <th class="sortable">Business Date</th>
                                <th class="sortable">Symbol</th>
                                <th class="sortable th-adj text-end">Adj Open</th>
                                <th class="sortable th-adj text-end">Adj High</th>
                                <th class="sortable th-adj text-end">Adj Low</th>
                                <th class="sortable th-adj text-end">Adj Close</th>
                                <th class="sortable text-end">Total Trade Qty</th>
                                <th class="sortable th-adj text-end">Adj 52W High</th>
                                <th class="sortable th-adj text-end">Adj 52W Low</th>
                                <th class="sortable text-end">Total Trades</th>
                                <th class="sortable th-adj text-end">Adj ATP</th>
                                <th class="sortable text-end">No of Shares</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in stock_prices %}
                            <tr>
                                <td>{{ price.business_date|date:"Y-m-d" }}</td>
                                <td>{{ price.symbol }}</td>
                                <td class="col-adj">{{ price.open_price_adj|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.high_price_adj|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.low_price_adj|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.close_price_adj|default_if_none:'N/A' }}</td>
                                <td>{{ price.total_traded_quantity|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.fifty_two_week_high_adj|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.fifty_two_week_low_adj|default_if_none:'N/A' }}</td>
                                <td>{{ price.total_trades|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.average_traded_price_adj|default_if_none:'N/A' }}</td>
                                <td>{{ price.no_of_shares|default_if_none:'N/A' }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="12" class="text-center">No adjusted stock price data found for {% if selected_date_str %}{{ selected_date_str }}{% else %}the latest trading day{% endif %}.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% elif view == 'corporate' %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0">Search Adjusted Prices by Company</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{% url 'nepse_data:todays_price' %}" class="row g-3 align-items-end">
                    <input type="hidden" name="view" value="corporate">
                    <div class="col-md-4">
                        <label for="search_term" class="form-label">Symbol or Company Name</label>
                        <input type="text" name="search_term" id="search_term" class="form-control" value="{{ search_term|default_if_none:'' }}" placeholder="e.g., NABIL or Nabil Bank" list="company-list" autocomplete="off">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </div>
                </form>

                <datalist id="company-list">
                    {% for company in all_companies %}
                        <option value="{{ company.script_ticker }}">{{ company.company_name }}</option>
                        <option value="{{ company.company_name }}">{{ company.script_ticker }}</option>
                    {% endfor %}
                </datalist>
            </div>
        </div>

        {% if search_term %}
        <div class="card shadow-sm border-0 mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Adjusted Price History for "{{ search_term }}"</h5>
                <a href="{% url 'nepse_data:download_stock_prices' %}?view=corporate&search_term={{ search_term|default_if_none:'' }}" class="btn btn-success btn-sm">Download as CSV</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="pricesTable" class="table table-striped table-hover table-bordered mb-0">
                        <thead>
                            <tr>
                                <th class="sortable">Business Date</th>
                                <th class="sortable">Symbol</th>
                                <th class="sortable th-adj text-end">Adj Open</th>
                                <th class="sortable th-adj text-end">Adj High</th>
                                <th class="sortable th-adj text-end">Adj Low</th>
                                <th class="sortable th-adj text-end">Adj Close</th>
                                <th class="sortable text-end">Total Trade Qty</th>
                                <th class="sortable th-adj text-end">Adj 52W High</th>
                                <th class="sortable th-adj text-end">Adj 52W Low</th>
                                <th class="sortable text-end">Total Trades</th>
                                <th class="sortable th-adj text-end">Adj ATP</th>
                                <th class="sortable text-end">No of Shares</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in stock_prices %}
                            <tr>
                                <td>{{ price.business_date|date:"Y-m-d" }}</td>
                                <td>{{ price.symbol }}</td>
                                <td class="col-adj">{{ price.open_price_adj|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.high_price_adj|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.low_price_adj|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.close_price_adj|default_if_none:'N/A' }}</td>
                                <td>{{ price.total_traded_quantity|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.fifty_two_week_high_adj|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.fifty_two_week_low_adj|default_if_none:'N/A' }}</td>
                                <td>{{ price.total_trades|default_if_none:'N/A' }}</td>
                                <td class="col-adj">{{ price.average_traded_price_adj|default_if_none:'N/A' }}</td>
                                <td>{{ price.no_of_shares|default_if_none:'N/A' }}</td>
                                </tr>
                            {% empty %}
                            <tr>
                                <td colspan="12" class="text-center">No adjusted stock price data found matching your search.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% endif %}

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function() {
        'use strict';

        // --- MODIFIED: VIEW_CONFIGS updated ---
        const VIEW_CONFIGS = {
            19: { // 'By Date' view
                stringColumns: [0, 1, 2, 3, 4, 14],
                floatColumns: [5, 6, 7, 8, 10, 11, 12, 13, 15, 17, 18],
                filterColumns: { symbol: 3, name: 4 },
                defaultSort: { column: 3, order: 'asc' }
            },
            16: { // 'By Company' view
                stringColumns: [0, 1, 11],
                floatColumns: [2, 3, 4, 5, 7, 8, 9, 10, 12, 14, 15],
                defaultSort: { column: 1, order: 'desc' }
            },
            12: { // 'Adj Price by Date' OR 'Adj Price by Company' view (12 columns)
                stringColumns: [0, 1],
                floatColumns: [2, 3, 4, 5, 7, 8, 10], // Cols that need 2+ decimals
                filterColumns: { symbol: 1 }, 
                defaultSort: { column: 1, order: 'asc' }, 
                factorColumn: -1 
            }
        };

        function getViewConfig(headerCount) {
            return VIEW_CONFIGS[headerCount] || null;
        }

        function formatNumbersInTable() {
            const table = document.getElementById('pricesTable');
            if (!table) return;

            const headers = table.querySelectorAll('thead th');
            const config = getViewConfig(headers.length);
            if (!config) return;

            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                if (row.cells.length <= 1) return; 

                for (let i = 0; i < row.cells.length; i++) {
                    if (config.stringColumns.includes(i)) continue;

                    const cell = row.cells[i];
                    const text = cell.textContent.trim();

                    if (!text || text === 'N/A') continue;

                    const num = parseFloat(text.replace(/,/g, ''));

                    if (!isNaN(num)) {
                        if (i === config.factorColumn && config.factorColumn !== -1) {
                            cell.textContent = num.toLocaleString('en-US', { 
                                minimumFractionDigits: 6, 
                                maximumFractionDigits: 6 
                            });
                        } else if (config.floatColumns.includes(i)) {
                            cell.textContent = num.toLocaleString('en-US', { 
                                minimumFractionDigits: 2, 
                                maximumFractionDigits: 2 
                            });
                        } else {
                            cell.textContent = num.toLocaleString('en-US');
                        }
                        cell.style.textAlign = 'right';
                        cell.style.fontVariantNumeric = 'tabular-nums';
                    }
                }
            });
        }

        function sortTable(columnIndex) {
            const table = document.getElementById('pricesTable');
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const headers = table.querySelectorAll('thead th');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            if (rows.length === 0 || rows[0].cells.length <= 1) return;

            const config = getViewConfig(headers.length);
            if (!config) return;

            const currentDirection = headers[columnIndex].classList.contains('asc') ? 'desc' : 'asc';

            headers.forEach(th => th.classList.remove('asc', 'desc'));
            headers[columnIndex].classList.add(currentDirection);

            rows.sort((a, b) => {
                let aText = a.cells[columnIndex].textContent.trim().replace(/,/g, '');
                let bText = b.cells[columnIndex].textContent.trim().replace(/,/g, '');

                let comparison;

                if (config.stringColumns.includes(columnIndex)) {
                    comparison = aText.localeCompare(bText, undefined, { sensitivity: 'base' });
                } else {
                    if (aText === 'N/A') aText = '';
                    if (bText === 'N/A') bText = '';

                    const aNum = parseFloat(aText);
                    const bNum = parseFloat(bText);

                    if (isNaN(aNum) && isNaN(bNum)) comparison = 0;
                    else if (isNaN(aNum)) comparison = -1;
                    else if (isNaN(bNum)) comparison = 1;
                    else comparison = aNum - bNum;
                }

                return currentDirection === 'asc' ? comparison : -comparison;
            });

            rows.forEach(row => tbody.appendChild(row));

            formatNumbersInTable();
        }

        function filterTable() {
            const filterInput = document.getElementById('priceSearch');
            if (!filterInput) return;

            const filter = filterInput.value.toUpperCase();
            const table = document.getElementById('pricesTable');
            const headers = table.querySelectorAll('thead th');
            const config = getViewConfig(headers.length);

            if (!config || !config.filterColumns) return;

            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                if (row.cells.length <= 1) return;

                let matches = false;

                if (config.filterColumns.symbol !== undefined) {
                    const symbolText = row.cells[config.filterColumns.symbol].textContent.toUpperCase();
                    matches = symbolText.includes(filter);
                }

                if (!matches && config.filterColumns.name !== undefined) {
                    const nameText = row.cells[config.filterColumns.name].textContent.toUpperCase();
                    matches = nameText.includes(filter);
                }

                row.style.display = matches ? '' : 'none';
            });
        }

        function applyDefaultSort() {
            const table = document.getElementById('pricesTable');
            if (!table) return;

            const headers = table.querySelectorAll('thead th');
            const rows = table.querySelector('tbody tr');

            if (!rows) return;

            const config = getViewConfig(headers.length);
            if (!config || !config.defaultSort) return;

            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');

            let sortColumn = config.defaultSort.column;
            let sortOrder = config.defaultSort.order;

            if (view === 'corporate') {
                sortColumn = 0;
                sortOrder = 'desc';
            } else if (view === 'adjusted') {
                sortColumn = 1;
                sortOrder = 'asc';
            } else if (view === 'company') {
                 sortColumn = 1;
                 sortOrder = 'desc';
            } else if (view === 'date') {
                sortColumn = 3;
                sortOrder = 'asc';
            }

            if (sortOrder === 'desc') {
                sortTable(sortColumn); 
                sortTable(sortColumn); 
            } else {
                sortTable(sortColumn);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const pricesTable = document.getElementById('pricesTable');
            if (!pricesTable) return;

            pricesTable.querySelectorAll('th.sortable').forEach((header, index) => {
                header.addEventListener('click', () => sortTable(index));
            });

            formatNumbersInTable();
            setTimeout(applyDefaultSort, 100);
        });

        window.filterTable = filterTable;
    })();
</script>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Data Entry Portal - NEPSE Analytics{% endblock %}

{% block content %}
<div class="row">
    <div class="col-xl-10 mx-auto">

        <div class="d-flex justify-content-end mb-2">
            <a href="{% url 'adjustments_stock_price:index' %}" target="_blank" class="fst-italic text-decoration-none">
                Stock Price Adjustment Tool &rarr;
            </a>
        </div>

        <h1 class="display-6 fw-bold">Data Input Portal</h1>
        <p class="fs-5 text-muted">Upload new market data files directly into the database.</p>

        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}

        <div class="card shadow-sm border-0 mt-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Upload Today's Price Data (CSV)</h5>
            </div>
            <div class="card-body p-4">
                <p class="card-text">
                    This form accepts a CSV file formatted like the standard "Today's Price" export.
                    The <strong>Business Date</strong> will be read automatically from the file's content.
                    The system will reject the upload if data for that date already exists.
                </p>
                <hr>
                <form method="POST" action="{% url 'nepse_data:data_entry' %}" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %} <div class="row g-3">
                        <div class="col-md-12">
                            <label for="price_file" class="form-label"><b>Price CSV File</b><span class="text-danger">*</span></label>
                            <input class="form-control" type="file" id="price_file" name="price_file" accept=".csv" required>
                            <div class="invalid-feedback">
                                Please select a .csv file to upload.
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#deletePriceModal">
                            <i class="bi bi-trash"></i>
                            Delete Price Data
                        </button>
                        
                        <button type="submit" name="action" value="upload_price" class="btn btn-primary btn-lg ms-2">
                            <i class="bi bi-upload"></i>
                            Upload Price Data
                        </button>
                    </div>
                </form>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">
                    The uploader will automatically clean the data by handling extra commas in security names.
                </small>
            </div>
        </div>

        <div class="card shadow-sm border-0 mt-5">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Upload Indices Data (CSV)</h5>
            </div>
            <div class="card-body p-4">
                <p class="card-text">
                    Upload a CSV file containing the daily indices data.
                    The system will skip any dates that already exist.
                </p>
                <hr>
                <form method="POST" action="{% url 'nepse_data:data_entry' %}" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="indices_file" class="form-label"><b>Indices CSV File</b><span class="text-danger">*</span></label>
                            <input class="form-control" type="file" id="indices_file" name="indices_file" accept=".csv" required>
                            <div class="invalid-feedback">
                                Please select a .csv file to upload.
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="submit" name="action" value="upload_indices" class="btn btn-success btn-lg ms-2">
                            <i class="bi bi-upload"></i>
                            Upload Indices Data
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm border-0 mt-5">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Upload Market Cap & Summary Data (CSV)</h5>
            </div>
            <div class="card-body p-4">
                <p class="card-text">
                    Upload a CSV file containing the daily market cap and summary data.
                    The system will update or create entries based on the <strong>Business Date</strong>.
                </p>
                <hr>
                <form method="POST" action="{% url 'nepse_data:data_entry' %}" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="marcap_file" class="form-label"><b>Market Cap CSV File</b><span class="text-danger">*</span></label>
                            <input class="form-control" type="file" id="marcap_file" name="marcap_file" accept=".csv" required>
                            <div class="invalid-feedback">
                                Please select a .csv file to upload.
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="submit" name="action" value="upload_marcap" class="btn btn-info btn-lg ms-2">
                            <i class="bi bi-upload"></i>
                            Upload Market Cap Data
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm border-0 mt-5">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">Upload Floorsheet Data (Excel/CSV)</h5>
            </div>
            <div class="card-body p-4">
                <p class="card-text">
                    Upload a single day's floorsheet file (Excel or CSV). You <strong>must</strong> select the
                    correct date for this data. The system will delete any existing floorsheet
                    and summary data for the selected date before importing.
                </p>
                <hr>
                <form method="POST" action="{% url 'nepse_data:data_entry' %}" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="floorsheet_file" class="form-label"><b>Floorsheet File</b><span class="text-danger">*</span></label>
                            <input class="form-control" type="file" id="floorsheet_file" name="floorsheet_file" accept=".csv,.xlsx,.xls" required>
                            <div class="invalid-feedback">
                                Please select a .csv or .xlsx file.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="floorsheet_date" class="form-label"><b>Calculation Date</b><span class="text-danger">*</span></label>
                            <input class="form-control" type="date" id="floorsheet_date" name="floorsheet_date" required>
                            <div class="invalid-feedback">
                                Please select a valid date for this data.
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#deleteFloorsheetModal">
                            <i class="bi bi-trash"></i>
                            Delete Floorsheet Data
                        </button>

                        <button type="submit" name="action" value="upload_floorsheet" class="btn btn-dark btn-lg ms-2">
                            <i class="bi bi-upload"></i>
                            Upload Floorsheet Data
                        </button>
                    </div>
                </form>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">
                    This process will also automatically re-calculate the Buyer, Seller, and Sector summaries for the selected date.
                </small>
            </div>
        </div>
        <div class="card shadow-sm border-0 mt-5">
            <div class="card-header bg-warning">
                <h5 class="mb-0">Recalculate All Adjusted Prices</h5>
            </div>
            <div class="card-body p-4">
                <p classV="card-text">
                    Click this button to run the optimized recalculation process. This will:
                    <br>1. Run a full adjustment for all symbols <strong>with</strong> corporate actions (bonus/right).
                    <br>2. Run a fast copy for all symbols <strong>without</strong> corporate actions.
                    <br>This ensures all 52-week high/low values are populated correctly.
                </p>
                <div class="text-end">
                    <button id="startRecalcButton" class="btn btn-warning btn-lg">
                        <i class="bi bi-arrow-clockwise"></i>
                        Start Full Recalculation
                    </button>
                </div>

                <div id="progressSection" class="mt-4" style="display: none;">
                    <div class="progress" role="progressbar" aria-label="Recalculation progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning text-dark" style="width: 0%">
                            <span id="progressText" class="fw-bold">Starting...</span>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small id="progressMessage" class="text-muted">Initializing job...</small>
                    </div>
                    <div id="jobCompleteControls" class="text-center mt-2" style="display: none;">
                        <button id="clearJobButton" class="btn btn-sm btn-outline-secondary">Clear</button>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>


<div class="modal fade" id="deletePriceModal" tabindex="-1" aria-labelledby="deletePriceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePriceModalLabel">Delete Price Data by Date</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'nepse_data:delete_price_data' %}">
                {% csrf_token %} <div class="modal-body">
                    <p>Select one or more dates to <strong>permanently delete</strong> all associated price data.
                    <br><small class="text-muted">(Hold Ctrl or Cmd to select multiple dates)</small></p>
                    
                    <div class="form-group">
                        <label for="dates_to_delete" class="form-label">Available Dates:</label>
                        <select class="form-select" 
                                multiple 
                                required 
                                name="dates_to_delete" 
                                id="dates_to_delete" 
                                size="15">
                        {% if available_dates %}
                            {% for row in available_dates %}
                                <option value="{{ row.business_date|date:"Y-m-d" }}">{{ row.business_date|date:"Y-m-d" }}</option>
                            {% endfor %}
                        {% else %}
                            <option disabled>No price data found in the database to delete.</option>
                        {% endif %}
                        </select>
                        <div class="invalid-feedback">
                            Please select at least one date.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" {% if not available_dates %}disabled{% endif %}>
                        <i class="bi bi-trash-fill"></i>
                        Confirm Delete
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteFloorsheetModal" tabindex="-1" aria-labelledby="deleteFloorsheetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteFloorsheetModalLabel">Delete Floorsheet Data by Date</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'nepse_data:delete_floorsheet_data' %}">
                {% csrf_token %} <div class="modal-body">
                    <p>Select one or more dates to <strong>permanently delete</strong> all associated floorsheet data.
                    <br><small class="text-danger fw-bold">Warning: This will also delete all Buyer, Seller, and Sector summaries for these dates.</small></p>
                    
                    <div class="form-group">
                        <label for="dates_to_delete" class="form-label">Available Floorsheet Dates:</label>
                        <select class="form-select" 
                                multiple 
                                required 
                                name="dates_to_delete" 
                                id="dates_to_delete_floorsheet" 
                                size="15">
                        {% if available_floorsheet_dates %}
                            {% for row in available_floorsheet_dates %}
                                <option value="{{ row.calculation_date|date:"Y-m-d" }}">{{ row.calculation_date|date:"Y-m-d" }}</option>
                            {% endfor %}
                        {% else %}
                            <option disabled>No floorsheet data found to delete.</option>
                        {% endif %}
                        </select>
                        <div class="invalid-feedback">
                            Please select at least one date.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" {% if not available_floorsheet_dates %}disabled{% endif %}>
                        <i class="bi bi-trash-fill"></i>
                        Confirm Delete
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script id="js-urls" type="application/json">
{
    "startRecalc": "{% url 'adjustments_stock_price:start_recalc' %}",
    "recalcStatus": "/adjustments/recalc-status/",
    "clearJob": "/adjustsments/clear-job/"
}
</script>

<script>
(function () {
'use strict'
var forms = document.querySelectorAll('.needs-validation')
Array.prototype.slice.call(forms)
    .forEach(function (form) {
    form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
        event.preventDefault()
        event.stopPropagation()
        }
        form.classList.add('was-validated')
    }, false)
    })
})()
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get URLs from the JSON script tag
    const URLS = JSON.parse(document.getElementById('js-urls').textContent);
    
    const startButton = document.getElementById('startRecalcButton');
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressMessage = document.getElementById('progressMessage');
    const jobCompleteControls = document.getElementById('jobCompleteControls');
    const clearJobButton = document.getElementById('clearJobButton');
    
    let currentJobId = null;
    let pollingInterval = null;

    // --- 1. Start Button Clicked ---
    startButton.addEventListener('click', function() {
        startButton.disabled = true;
        startButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Starting...';
        progressSection.style.display = 'block';
        jobCompleteControls.style.display = 'none';
        setProgressBar(0, 'Starting...', 'Initializing job...', 'bg-warning', true);
        
        // Find the *first* CSRF token on the page (more reliable)
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

        // Call the "start" endpoint
        fetch(URLS.startRecalc, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken // Send CSRF token
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'started') {
                currentJobId = data.job_id;
                startButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
                startPolling(currentJobId);
            } else {
                throw new Error(data.message || 'Failed to start job.');
            }
        })
        .catch(error => {
            console.error('Error starting job:', error);
            progressMessage.innerText = `Error: ${error.message}`;
            setProgressBar(100, 'Error', 'Error starting job.', 'bg-danger', false);
            startButton.disabled = false;
            startButton.innerHTML = 'Start Full Recalculation';
        });
    });

    // --- 2. Poll for Status (Reads Celery's state) ---
    function startPolling(jobId) {
        pollingInterval = setInterval(() => {
            fetch(`${URLS.recalcStatus}${jobId}/`)
            .then(response => response.json())
            .then(status => {
                if (!status) return;

                let percent = 0;
                if (status.total > 0) {
                    percent = (status.progress / status.total) * 100;
                }
                
                progressMessage.innerText = status.message || '...';
                
                if (status.status === 'running' || status.status === 'PROGRESS') {
                    setProgressBar(percent, `${Math.round(percent)}%`, status.message, 'bg-warning', true);
                } 
                else if (status.status === 'complete' || status.status === 'SUCCESS') {
                    setProgressBar(100, 'Complete!', status.message, 'bg-success', false);
                    finishPolling(jobId, false);
                }
                else if (status.status === 'error' || status.status === 'FAILURE') {
                    setProgressBar(100, 'Error!', status.message, 'bg-danger', false);
                    finishPolling(jobId, true);
                }
                else if (status.status === 'pending') {
                    setProgressBar(0, 'Pending...', 'Job is queued...', 'bg-warning', true);
                }
            })
            .catch(error => {
                console.error('Polling error:', error);
                setProgressBar(100, 'Error!', 'Connection lost.', 'bg-danger', false);
                finishPolling(null, true);
            });
        }, 1500); 
    }
    
    function setProgressBar(percent, text, message, barClass, isAnimated) {
        progressBar.style.width = percent + '%';
        progressBar.setAttribute('aria-valuenow', percent);
        progressText.innerText = text;
        progressMessage.innerText = message;
        progressBar.classList.remove('bg-warning', 'bg-success', 'bg-danger');
        progressBar.classList.add(barClass);
        if (isAnimated) {
            progressBar.classList.add('progress-bar-animated', 'progress-bar-striped');
        } else {
            progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
        }
    }
    
    function finishPolling(jobId, isError) {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        startButton.disabled = false;
        startButton.innerHTML = 'Start Full Recalculation';
        jobCompleteControls.style.display = 'block';
    }
    
    clearJobButton.addEventListener('click', function() {
        progressSection.style.display = 'none';
        jobCompleteControls.style.display = 'none';
        setProgressBar(0, '', '', 'bg-warning', true);
        if (currentJobId) {
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            fetch(`${URLS.clearJob}${currentJobId}/`, { 
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            });
            currentJobId = null;
        }
    });
});
</script>

{% endblock %}
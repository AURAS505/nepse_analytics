{% extends 'base.html' %}
{% load humanize %} 

{% block title %}{{ title }} - NEPSE Analytics{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #4a5568;
        --secondary-color: #718096;
        --light-gray: #f7fafc;
        --border-gray: #e2e8f0;
        --medium-gray: #cbd5e0;
        --dark-gray: #2d3748;
        --hover-bg: #edf2f7;
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --accent-blue: #5a67d8;
        --accent-green: #48bb78;
    }

    body {
        background-color: #f9fafb;
        color: var(--text-primary);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .page-header {
        background-color: white;
        border: 1px solid var(--border-gray);
        padding: 1.75rem 1.5rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .page-header h1 {
        font-size: 1.875rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--dark-gray);
    }

    .page-header p {
        color: var(--text-secondary);
        margin-bottom: 0;
        font-size: 0.9375rem;
    }

    .filter-card {
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid var(--border-gray);
        margin-bottom: 1.5rem;
    }

    .filter-card .card-body {
        padding: 1.5rem;
    }

    .form-label {
        color: var(--text-primary);
        font-weight: 500;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border: 1px solid var(--medium-gray);
        border-radius: 4px;
        padding: 0.5rem 0.75rem;
        font-size: 0.9375rem;
        transition: border-color 0.15s ease;
        background-color: white;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--accent-blue);
        outline: none;
        box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.1);
    }

    .btn {
        border-radius: 4px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        font-size: 0.9375rem;
        transition: all 0.15s ease;
        border: 1px solid;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--dark-gray);
        border-color: var(--dark-gray);
        color: white;
    }

    .btn-outline-secondary {
        border-color: var(--medium-gray);
        color: var(--text-primary);
        background: white;
    }

    .btn-outline-secondary:hover {
        background-color: var(--light-gray);
        border-color: var(--secondary-color);
        color: var(--text-primary);
    }

    .btn-success {
        background-color: var(--accent-green);
        border-color: var(--accent-green);
        color: white;
    }

    .btn-success:hover {
        background-color: #38a169;
        border-color: #38a169;
        color: white;
    }

    .data-card {
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid var(--border-gray);
        overflow: hidden;
    }

    .table-responsive {
        border-radius: 6px;
    }

    .table {
        margin-bottom: 0;
        font-size: 0.9375rem;
    }

    .table thead th {
        background-color: var(--primary-color);
        color: white;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.8125rem;
        letter-spacing: 0.3px;
        padding: 0.875rem 0.75rem;
        border: none;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table thead th.sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 2rem;
    }

    .table thead th.sortable:hover {
        background-color: var(--dark-gray);
    }

    .table thead th.sortable::after {
        content: '⇅';
        position: absolute;
        right: 0.75rem;
        opacity: 0.6;
        font-size: 0.875rem;
    }

    .table thead th.sortable.asc::after {
        content: '↑';
        opacity: 1;
    }

    .table thead th.sortable.desc::after {
        content: '↓';
        opacity: 1;
    }

    .table tbody tr {
        transition: background-color 0.15s ease;
        border-bottom: 1px solid var(--border-gray);
    }

    .table tbody tr:hover {
        background-color: var(--hover-bg);
    }

    .table tbody tr:last-child {
        border-bottom: none;
    }

    .table tbody td {
        padding: 0.875rem 0.75rem;
        vertical-align: middle;
        color: var(--text-primary);
    }

    .table tbody td.fw-bold {
        color: var(--accent-blue);
        font-weight: 600;
    }

    .status-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.8125rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-badge.open {
        background-color: #48bb78;
        color: white;
    }

    .status-badge.closed {
        background-color: #c53030;
        color: white;
    }

    .pagination {
        margin: 0;
    }

    .page-link {
        color: var(--text-primary);
        border: 1px solid var(--border-gray);
        border-radius: 4px;
        margin: 0 0.25rem;
        padding: 0.5rem 0.75rem;
        font-weight: 500;
        transition: all 0.15s ease;
        background-color: white;
    }

    .page-link:hover {
        background-color: var(--hover-bg);
        border-color: var(--medium-gray);
        color: var(--dark-gray);
    }

    .page-item.active .page-link {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        font-weight: 600;
    }

    .page-item.disabled .page-link {
        background-color: var(--light-gray);
        border-color: var(--border-gray);
        color: var(--text-secondary);
    }

    .card-footer {
        background-color: var(--light-gray);
        border-top: 1px solid var(--border-gray);
    }

    .alert {
        border-radius: 4px;
        border-left-width: 4px;
    }

    .text-muted {
        color: var(--text-secondary) !important;
    }

    /* Subtle striping */
    .table tbody tr:nth-child(even) {
        background-color: #fafbfc;
    }

    .table tbody tr:nth-child(even):hover {
        background-color: var(--hover-bg);
    }

    @media (max-width: 768px) {
        .page-header h1 {
            font-size: 1.5rem;
        }
        
        .page-header p {
            font-size: 0.875rem;
        }

        .table {
            font-size: 0.8125rem;
        }

        .table thead th {
            padding: 0.75rem 0.5rem;
            font-size: 0.75rem;
        }

        .table tbody td {
            padding: 0.75rem 0.5rem;
        }
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            
            <div class="page-header">
                <h1>{{ title }}</h1>
                <p>View all historical dividend and right share data. Use the filters to narrow your search.</p>
            </div>

            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}

            <div class="card filter-card">
                <div class="card-body">
                    <form method="GET" action="{% url 'nepse_data:dividend_history' %}" class="row g-3 align-items-end">
                        
                        <div class="col-md-3">
                            <label for="symbol" class="form-label">Symbol</label>
                            <input type="text" name="symbol" id="symbol" class="form-control" value="{{ symbol|default:'' }}" placeholder="Enter Symbol (e.g., NIFRA)">
                        </div>

                        <div class="col-md-3">
                            <label for="fiscal_year" class="form-label">Fiscal Year</label>
                            <select name="fiscal_year" id="fiscal_year" class="form-select">
                                <option value="">All Fiscal Years</option>
                                {% for fy in filter_options.fiscal_years %}
                                    {% if fy %}
                                    <option value="{{ fy }}" {% if fy == fiscal_year %}selected{% endif %}>{{ fy }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="per_page" class="form-label">Per Page</label>
                            <select name="per_page" id="per_page" class="form-select" onchange="this.form.submit()">
                                <option value="20" {% if per_page == '20' %}selected{% endif %}>20</option>
                                <option value="50" {% if per_page == '50' %}selected{% endif %}>50</option>
                                <option value="100" {% if per_page == '100' %}selected{% endif %}>100</option>
                                <option value="All" {% if per_page == 'All' %}selected{% endif %}>All</option>
                            </select>
                        </div>

                        <div class="col-md-4 d-flex justify-content-end align-items-end gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Filter
                            </button>
                            <a href="{% url 'nepse_data:dividend_history' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Clear
                            </a>
                            <a href="{% url 'nepse_data:download_dividend_history' %}?{{ request.GET.urlencode }}" class="btn btn-success" title="Download current view">
                                <i class="bi bi-download"></i> Download
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card data-card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="dividendTable">
                            <thead>
                                <tr>
                                    <th scope="col">FY</th>
                                    <th scope="col">Symbol</th>
                                    <th scope="col">Company</th>
                                    <th scope="col" class="text-end sortable" data-column="bonus">Bonus %</th>
                                    <th scope="col" class="text-end sortable" data-column="cash">Cash %</th>
                                    <th scope="col" class="text-end sortable" data-column="right">Right %</th>
                                    <th scope="col" class="text-end sortable" data-column="tax">Tax %</th>
                                    <th scope="col" class="text-end sortable" data-column="total">Total %</th>
                                    <th scope="col" class="sortable" data-column="announced">Announced</th>
                                    <th scope="col" class="sortable" data-column="bookclose">Book Close</th>
                                    <th scope="col">Status</th>
                                    <th scope="col" class="sortable" data-column="dist">Dist. Date</th>
                                    <th scope="col" class="sortable" data-column="bonuslist">Bonus List</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in dividend_data %}
                                <tr>
                                    <td class="fw-bold">{{ item.fiscal_year|default:'-' }}</td>
                                    <td class="fw-bold">{{ item.symbol }}</td>
                                    <td>{{ item.company_name|default:'-'|truncatechars:30 }}</td>
                                    <td class="text-end" data-value="{{ item.bonus_percent|default:'0' }}">{{ item.bonus_percent|default_if_none:'-' }}</td>
                                    <td class="text-end" data-value="{{ item.cash_percent|default:'0' }}">{{ item.cash_percent|default_if_none:'-' }}</td>
                                    <td class="text-end" data-value="{{ item.right_percent|default:'0' }}">{{ item.right_percent|default_if_none:'-' }}</td>
                                    <td class="text-end" data-value="{{ item.tax_percent|default:'0' }}">{{ item.tax_percent|default_if_none:'-' }}</td>
                                    <td class="text-end fw-bold" data-value="{{ item.total_percent|default:'0' }}">{{ item.total_percent|default_if_none:'-' }}</td>
                                    <td data-value="{{ item.announcement_date|date:'Y-m-d'|default:'' }}">{{ item.announcement_date|date:"Y-m-d"|default:'-' }}</td>
                                    <td data-value="{{ item.book_closure_date|date:'Y-m-d'|default:'' }}">{{ item.book_closure_date|date:"Y-m-d"|default:'-' }}</td>
                                    <td class="book-close-status" data-book-close="{{ item.book_closure_date|date:'Y-m-d'|default:'' }}">
                                        <span class="status-badge">-</span>
                                    </td>
                                    <td data-value="{{ item.distribution_date|date:'Y-m-d'|default:'' }}">{{ item.distribution_date|date:"Y-m-d"|default:'-' }}</td>
                                    <td data-value="{{ item.bonus_listing_date|date:'Y-m-d'|default:'' }}">{{ item.bonus_listing_date|date:"Y-m-d"|default:'-' }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="13" class="text-center p-4">
                                        <h4 class="text-muted">No dividend data found.</h4>
                                        <p>Try clearing your filters or <a href="{% url 'nepse_data:data_entry' %}">uploading new data</a>.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                {% if paginator %}
                <div class="card-footer p-3">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&per_page={{ per_page }}" aria-label="First">
                                        &laquo;&laquo;
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&per_page={{ per_page }}" aria-label="Previous">
                                        &laquo;
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">&laquo;&laquo;</span></li>
                                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                            {% endif %}
                
                            <li class="page-item active" aria-current="page">
                                <span class="page-link">
                                    Page {{ page_obj.number }} of {{ paginator.num_pages }}
                                </span>
                            </li>
                
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&per_page={{ per_page }}" aria-label="Next">
                                        &raquo;
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ paginator.num_pages }}&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}&per_page={{ per_page }}" aria-label="Last">
                                        &raquo;&raquo;
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                                <li class="page-item disabled"><span class="page-link">&raquo;&raquo;</span></li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculate and display book close status
    function updateBookCloseStatus() {
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison
        
        const statusCells = document.querySelectorAll('.book-close-status');
        statusCells.forEach(cell => {
            const bookCloseDate = cell.dataset.bookClose;
            const badge = cell.querySelector('.status-badge');
            
            if (!bookCloseDate || bookCloseDate === '') {
                badge.textContent = '-';
                badge.classList.remove('open', 'closed');
            } else {
                const closeDate = new Date(bookCloseDate);
                closeDate.setHours(0, 0, 0, 0);
                
                if (today <= closeDate) {
                    badge.textContent = 'Open';
                    badge.classList.add('open');
                    badge.classList.remove('closed');
                } else {
                    badge.textContent = 'Closed';
                    badge.classList.add('closed');
                    badge.classList.remove('open');
                }
            }
        });
    }
    
    // Run on page load
    updateBookCloseStatus();
    
    // Sorting functionality
    const table = document.getElementById('dividendTable');
    const headers = table.querySelectorAll('th.sortable');
    
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.column;
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Skip if no data
            if (rows.length === 1 && rows[0].cells.length === 1) return;
            
            // Determine sort direction
            const isAsc = this.classList.contains('asc');
            const isDesc = this.classList.contains('desc');
            
            // Remove all sort classes from all headers
            headers.forEach(h => {
                h.classList.remove('asc', 'desc');
            });
            
            // Set new sort direction
            if (!isAsc && !isDesc) {
                this.classList.add('asc');
            } else if (isAsc) {
                this.classList.add('desc');
            } else {
                this.classList.add('asc');
            }
            
            const direction = this.classList.contains('asc') ? 1 : -1;
            const columnIndex = Array.from(this.parentElement.children).indexOf(this);
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue = a.cells[columnIndex].dataset.value || a.cells[columnIndex].textContent;
                let bValue = b.cells[columnIndex].dataset.value || b.cells[columnIndex].textContent;
                
                // Handle numeric values
                if (!isNaN(parseFloat(aValue)) && !isNaN(parseFloat(bValue))) {
                    aValue = parseFloat(aValue);
                    bValue = parseFloat(bValue);
                } else {
                    // Handle dates and strings
                    aValue = aValue.toString().trim();
                    bValue = bValue.toString().trim();
                    
                    // Handle empty/dash values
                    if (aValue === '-' || aValue === '') aValue = '';
                    if (bValue === '-' || bValue === '') bValue = '';
                }
                
                if (aValue === '' && bValue === '') return 0;
                if (aValue === '') return 1;
                if (bValue === '') return -1;
                
                if (aValue < bValue) return -1 * direction;
                if (aValue > bValue) return 1 * direction;
                return 0;
            });
            
            // Reorder rows
            rows.forEach(row => tbody.appendChild(row));
            
            // Re-update status badges after sorting
            updateBookCloseStatus();
        });
    });
});
</script>

{% endblock %}
{% extends 'base.html' %}

{% block title %}{{ title }} - NEPSE Analytics{% endblock %}

{% block styles %}
    <style>
        .table-container { max-height: 70vh; overflow-y: auto; }
        .table th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
        /* ... (other styles from your file are fine) ... */
        .action-buttons form { display: inline; }
        .table th.sortable { cursor: pointer; user-select: none; }
        .table th.sortable:hover { background-color: #e9ecef; }
        .table th.sortable::after { content: '\2195'; font-size: 0.9em; margin-left: 5px; opacity: 0.3; }
        .table th.sortable.asc::after { content: '\2191'; opacity: 1; }
        .table th.sortable.desc::after { content: '\2193'; opacity: 1; }
    </style>
{% endblock %}

{% block content %}
{% if messages %}
<div class="row">
    <div class="col-xl-11 mx-auto">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-xl-11 mx-auto">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-center">
                <h5 class="mb-2 mb-md-0">Listed Companies in NEPSE</h5>
                <div class="d-flex align-items-center">
                    <button class="btn btn-info btn-sm me-2" id="checkMissingBtn">Check for Missing Companies</button>
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" id="companySearch" onkeyup="filterTable()" class="form-control form-control-sm" placeholder="Search by Script / Ticker...">
                        <button class="btn btn-outline-secondary btn-sm" onclick="filterTable()">Search</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCompanyModal">Add New Company</button>
                    <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadCompanyModal">Upload Companies (CSV/XLSX)</button>
                    <a href="{% url 'listed_companies:download' %}" class="btn btn-success btn-sm">Download as CSV</a>
                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteAllModal">Delete All Companies</button>
                </div>
                <div class="table-container">
                    <table id="companiesTable" class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="sortable">NEPSE Code</th>
                                <th class="sortable">Script / Ticker</th>
                                <th class="sortable">Company Name</th>
                                <th class="sortable">Sector</th>
                                <th class="sortable">Type</th>
                                <th class="sortable">Status</th>
                                <th>Instrument</th>
                                <th class="sortable">Par Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for company in companies %}
                            <tr>
                                <td>{{ company.nepse_code }}</td>
                                <td>{{ company.script_ticker }}</td>
                                <td>{{ company.company_name }}</td>
                                <td>{{ company.sector }}</td>
                                <td>{{ company.type }}</td>
                                <td><span class="badge bg-{% if company.status == 'Active' %}success{% else %}warning{% endif %}">{{ company.status }}</span></td>
                                <td>{{ company.instrument }}</td>
                                <td>{{ company.par_value|floatformat:2 }}</td>
                                <td class="action-buttons">
                                    <a href="{% url 'listed_companies:edit' company.nepse_code %}" class="btn btn-warning btn-sm">Edit</a>
                                    <form action="{% url 'listed_companies:delete' company.nepse_code %}" method="POST" onsubmit="return confirm('Are you sure you want to delete this company?');" style="display: inline;">
                                        {% csrf_token %} <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addCompanyModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCompanyForm">
                    {% csrf_token %} <div id="addCompanyMessage" class="d-none"></div>
                    <div class="row g-3">
                        <div class="col-md-6"><label for="add_nepse_code" class="form-label">NEPSE Code</label><input type="text" class="form-control" id="add_nepse_code" name="nepse_code" required></div>
                        <div class="col-md-6"><label for="add_script_ticker" class="form-label">Script / Ticker</label><input type="text" class="form-control" id="add_script_ticker" name="script_ticker" required></div>
                        <div class="col-12"><label for="add_company_name" class="form-label">Company Name</label><input type="text" class="form-control" id="add_company_name" name="company_name" required></div>

                        <div class="col-md-6">
                            <label for="add_sector" class="form-label">Sector</label>
                            <select id="add_sector" name="sector" class="form-select">
                                <option value="Commercial Banks" selected>Commercial Banks</option>
                                <option value="Development Banks">Development Banks</option>
                                <option value="Finance">Finance</option>
                                <option value="Float">Float</option>
                                <option value="Hotels And Tourism">Hotels And Tourism</option>
                                <option value="Hydro Power">Hydro Power</option>
                                <option value="Investment">Investment</option>
                                <option value="Life Insurance">Life Insurance</option>
                                <option value="Manufacturing And Processing">Manufacturing And Processing</option>
                                <option value="Microfinance">Microfinance</option>
                                <option value="Mutual Fund">Mutual Fund</option>
                                <option value="Nepse">Nepse</option>
                                <option value="Non Life Insurance">Non Life Insurance</option>
                                <option value="Non-Convertible Debentures">Non-Convertible Debentures</option>
                                <option value="Others">Others</option>
                                <option value="Sen. Float">Sen. Float</option>
                                <option value="Sensitive">Sensitive</option>
                                <option value="Tradings">Tradings</option>
                            </select>
                        </div>

                        <div class="col-md-6"><label for="add_type" class="form-label">Type</label><select id="add_type" name="type" class="form-select"><option value="Public" selected>Public</option><option value="Promoter">Promoter</option><option value="Other">Other</option></select></div>
                        <div class="col-md-6"><label for="add_status" class="form-label">Status</label><select id="add_status" name="status" class="form-select"><option value="Active" selected>Active</option><option value="Suspended">Suspended</option><option value="Delisted">Delisted</option></select></div>
                        <div class="col-md-6"><label for="add_instrument" class="form-label">Instrument</label><select id="add_instrument" name="instrument" class="form-select"><option value="Equity" selected>Equity</option><option value="Non-Convertible Debentures">Non-Convertible Debentures</option><option value="Mutual Funds">Mutual Funds</option><option value="Other">Other</option></select></div>

                        <div class="col-md-6">
                            <label for="add_par_value" class="form-label">Par Value</label>
                            <input type="number" step="0.01" class="form-control" id="add_par_value" name="par_value" value="100.00" min="0.01" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addCompanyForm" class="btn btn-primary">Add Company</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadCompanyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'listed_companies:upload' %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %} <div class="modal-header">
                    <h5 class="modal-title">Upload Companies (CSV/XLSX)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label for="upload_file" class="form-label">Select CSV or XLSX file:</label>
                    <input type="file" class="form-control" id="upload_file" name="file" accept=".csv, .xlsx, .xls" required>
                    <div class="mt-3 p-3 bg-light rounded border">
                        <p class="mb-2 fw-bold text-danger">Important:</p>
                        <p class="small">The 'sector' column in your file must contain one of the predefined values. The upload will fail if any other sector name is used. Please ensure your data is clean before uploading.</p>
                         <hr>
                        <p class="mb-2">Download a sample file to ensure correct column headers:</p>
                        <a href="{% url 'listed_companies:download_sample_csv' %}" class="btn btn-sm btn-outline-success">Sample CSV</a>
                        <a href="{% url 'listed_companies:download_sample_xlsx' %}" class="btn btn-sm btn-outline-success">Sample XLSX</a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload File</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="checkMissingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="checkMissingModalTitle">Company Check Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="checkMissingModalBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteAllModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'listed_companies:delete_all' %}" method="POST">
                {% csrf_token %} <div class="modal-header">
                    <h5 class="modal-title text-danger">WARNING: Permanent Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you absolutely sure you want to delete <strong>ALL</strong> companies from the database?</p>
                    <p class="text-danger fw-bold">This action is irreversible and will permanently remove all company records.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete All</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    // --- THIS IS THE MISSING SEARCH FUNCTION ---
    function filterTable() {
        const filter = document.getElementById('companySearch').value.toUpperCase();
        const rows = document.getElementById('companiesTable').querySelectorAll('tbody tr');
        rows.forEach(row => {
            // Filter by Script/Ticker (column 1)
            const tickerCell = row.cells[1]; 
            if (tickerCell) {
                const tickerText = tickerCell.textContent || tickerCell.innerText;
                row.style.display = tickerText.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
        });
    }

    // --- THIS IS THE MISSING SORT FUNCTION ---
    function sortTable(columnIndex) {
        const table = document.getElementById('companiesTable');
        const tbody = table.querySelector('tbody');
        const headers = table.querySelectorAll('thead th');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const currentDirection = headers[columnIndex].classList.contains('asc') ? 'desc' : 'asc';
        
        headers.forEach(th => th.classList.remove('asc', 'desc'));
        headers[columnIndex].classList.add(currentDirection);
        
        rows.sort((a, b) => {
            const aText = a.cells[columnIndex].textContent.trim();
            const bText = b.cells[columnIndex].textContent.trim();
            const aNum = parseFloat(aText);
            const bNum = parseFloat(bText);
            let comparison;

            if (!isNaN(aNum) && !isNaN(bNum)) {
                comparison = aNum > bNum ? 1 : -1;
            } else {
                comparison = aText.localeCompare(bText, undefined, { sensitivity: 'base' });
            }
            return currentDirection === 'asc' ? comparison : -comparison;
        });
        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));
    }

    // --- This is your new Django-specific JavaScript ---
    document.addEventListener('DOMContentLoaded', function () {
        const addCompanyForm = document.getElementById('addCompanyForm');
        const addCompanyMessage = document.getElementById('addCompanyMessage');
        const addCompanyModalEl = document.getElementById('addCompanyModal');
        const addCompanyModal = new bootstrap.Modal(addCompanyModalEl);
        
        // Get the CSRF token from the form
        const csrfToken = addCompanyForm.querySelector('input[name="csrfmiddlewaretoken"]').value;

        if(addCompanyForm) {
            addCompanyForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const formData = new FormData(addCompanyForm);
                
                try {
                    const response = await fetch("{% url 'listed_companies:add' %}", {
                        method: 'POST',
                        body: new URLSearchParams(formData),
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    });
                    const data = await response.json();
                    addCompanyMessage.className = 'alert';
                    if (response.ok) {
                        addCompanyMessage.classList.add('alert-success');
                        addCompanyMessage.textContent = data.message;
                        setTimeout(() => {
                            addCompanyModal.hide();
                            location.reload();
                        }, 1500);
                    } else {
                        addCompanyMessage.classList.add('alert-danger');
                        addCompanyMessage.textContent = data.message;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addCompanyMessage.className = 'alert alert-danger';
                    addCompanyMessage.textContent = 'An unexpected error occurred. Please try again.';
                }
            });
        }

        // --- Missing Company Check (This will work now) ---
        const checkMissingBtn = document.getElementById('checkMissingBtn');
        const checkMissingModalEl = document.getElementById('checkMissingModal');
        const checkMissingModal = new bootstrap.Modal(checkMissingModalEl);
        const checkMissingModalTitle = document.getElementById('checkMissingModalTitle');
        const checkMissingModalBody = document.getElementById('checkMissingModalBody');

        if(checkMissingBtn) {
            checkMissingBtn.addEventListener('click', async function() {
                checkMissingBtn.disabled = true;
                checkMissingBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';
                
                try {
                    const response = await fetch("{% url 'listed_companies:check_missing' %}");
                    const data = await response.json();

                    if (response.ok && data.status === 'success') {
                        if (data.missing_companies.length > 0) {
                            checkMissingModalTitle.textContent = '‚ö†Ô∏è Missing Companies Found';
                            let listHtml = '<p>The following symbols exist in price data but not in your company list. Please add them:</p><ul class="list-group">';
                            data.missing_companies.forEach(company => {
                                listHtml += `<li class="list-group-item">${company}</li>`;
                            });
                            listHtml += '</ul>';
                            checkMissingModalBody.innerHTML = listHtml;
                        } else {
                            checkMissingModalTitle.textContent = 'All Good! üëç';
                            checkMissingModalBody.innerHTML = '<div class="alert alert-success mb-0">Your company list is up-to-date. No missing symbols were found.</div>';
                        }
                    } else {
                        checkMissingModalTitle.textContent = 'Error';
                        checkMissingModalBody.innerHTML = `<div class="alert alert-danger mb-0">${data.message || 'An unknown error occurred.'}</div>`;
                    }
                } catch (error) {
                    checkMissingModalTitle.textContent = 'Error';
                    checkMissingModalBody.innerHTML = '<div class="alert alert-danger mb-0">Failed to connect to the server.</div>';
                } finally {
                    checkMissingBtn.disabled = false;
                    checkMissingBtn.innerHTML = 'Check for Missing Companies';
                    checkMissingModal.show();
                }
            });
        }
        
        // --- Sorting/Filtering triggers (This part was also missing) ---
        document.querySelectorAll('#companiesTable th.sortable').forEach((header, index) => {
            header.addEventListener('click', () => sortTable(index));
        });
        setTimeout(() => {
            if(document.querySelector('#companiesTable tbody tr')) {
                sortTable(1); // Sort by Script/Ticker (ASC)
            }
        }, 100);
    });
</script>
{% endblock %}